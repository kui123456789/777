# 末日避难所角色卡 - 酒馆导入指南

## 项目概述

这是一个基于 MVU 变量框架的末日避难所管理类角色卡。玩家扮演避难所的监督者(Overseer)，管理资源、维持秩序、处理派系冲突，在末日废土中带领幸存者生存。

## 导入步骤

### 前置要求

1. 已安装 SillyTavern（酒馆）
2. 已安装酒馆助手扩展
3. 已在本地运行 `pnpm watch` 或 `pnpm build`
4. 已启动 Live Server（VS Code 插件，默认端口 5500）

### 第一步：导入脚本

1. 打开酒馆，进入 **扩展** → **酒馆助手** → **脚本库**
2. 点击 **导入脚本**
3. 依次导入 `导入到酒馆中/` 文件夹中的脚本 JSON 文件：
   - `MVU脚本-实时修改.json` - MVU 变量框架（必需）
   - `变量结构脚本-实时修改.json` - 变量结构定义（必需）
4. **启用**这两个脚本

### 第二步：导入世界书

#### 方法 A：手动导入

1. 运行命令生成世界书文件：

```bash
node tavern_sync.mjs bundle 末日避难所
```

2. 将生成的 `世界书/末日避难所.json` 导入酒馆的世界书

#### 方法 B：Docker 用户 - 使用实时同步脚本

如果你的 SillyTavern 运行在 Docker 中，可以使用世界书同步脚本：

1. 编辑 `scripts/worldbook_sync.mjs`，修改 CONFIG 中的路径配置：

```javascript
const CONFIG = {
  worldbookName: '末日避难所',
  bundledJsonPath: 'src/角色卡/末日避难所/世界书/末日避难所.json',
  dockerVolumePath: 'D:/你的/SillyTavern/data路径/worlds/末日避难所.json',
  watchDir: 'src/角色卡/末日避难所/世界书',
};
```

2. 运行同步命令：

```bash
# 监听模式 - 自动监听文件变化并同步
pnpm run sync:worldbook

# 单次同步
pnpm run sync:worldbook:once
```

3. 同步后，在酒馆中执行 `/ejs-refresh` 命令刷新世界书缓存

### 第三步：导入界面正则（可选）

如果需要在消息中显示状态栏界面：

1. 打开酒馆，进入 **扩展** → **正则表达式**
2. 点击 **导入**
3. 导入 `导入到酒馆中/状态栏界面-实时修改.json`
4. 根据需要启用该正则

### 第四步：创建角色卡

1. 在酒馆中创建新角色卡
2. 在角色卡设置中关联 **末日避难所** 世界书
3. 将 `第一条消息/0.txt` 的内容复制到角色卡的第一条消息
4. 开始对话！

## 开发模式

在开发时，建议：

1. 运行 `pnpm watch` 保持代码自动编译
2. 启动 VS Code 的 Live Server 插件
3. 在酒馆助手中启用"实时监听"功能，代码修改后会自动热重载

## 目录结构

```
末日避难所/
├── schema.ts              # MVU 变量结构定义
├── schema.json            # 自动生成的 JSON Schema
├── 脚本/
│   ├── MVU/              # MVU 框架加载脚本
│   └── 变量结构/          # 变量结构注册脚本
├── 界面/
│   └── 状态栏/           # 状态栏 Vue 组件
├── 世界书/
│   ├── index.yaml        # 世界书主配置
│   ├── 基础设定.yaml     # 游戏设定
│   ├── 生存指南.yaml     # AI 扮演指南
│   ├── 变量/             # 变量相关条目
│   └── 立即事件/         # 事件触发条目
├── 第一条消息/
│   └── 0.txt             # 开场剧情
└── 导入到酒馆中/         # 酒馆导入用 JSON 文件
```

## 游戏系统

### 六大核心系统

1. **世界环境层** - 灾难类型、时间线节点
2. **避难所状态层** - 资源、环境指标、社会制度、宏观属性
3. **派系系统** - 技术派、生存派、秩序派、自由派
4. **设施与库存** - 设施建造、物品管理
5. **监督者系统** - S.P.E.C.I.A.L 属性、特质、行动点
6. **追随者系统** - 招募、培养、任务分配

### S.P.E.C.I.A.L 属性

- **S** 威慑力 - 镇压叛乱、恐吓敌人
- **P** 洞察力 - 预警危险、识破阴谋
- **E** 抗压值 - 承受压力、高强度工作
- **C** 统御力 - 说服、交易、招募
- **I** 科研力 - 研发、维修、破解
- **A** 反应力 - 突发危机处理
- **L** 气运 - 全域检定加成（数值×33%）

## 常见问题

**Q: 界面不显示怎么办？**
A: 检查 Live Server 是否启动，端口是否为 5500

**Q: 变量没有更新怎么办？**
A: 确保 MVU 脚本和变量结构脚本都已启用

**Q: 如何修改初始变量值？**
A: 编辑 `世界书/变量/initvar.yaml` 文件

**Q: Docker 中世界书同步后不生效？**
A: 在酒馆中执行 `/ejs-refresh` 命令刷新世界书缓存

**Q: 如何让 worldbook_sync.mjs 支持自动刷新浏览器？**
A:
1. 确保已安装 ws 模块：`pnpm add -D ws`
2. 启动 Chrome 时添加远程调试参数：`chrome --remote-debugging-port=9222`
3. 脚本会自动通过 CDP 刷新酒馆缓存
