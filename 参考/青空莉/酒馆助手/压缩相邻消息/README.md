# 压缩相邻消息

- **作者:** 青空莉想做舞台少女的狗
- **版本:** 2025/10/23
- **源文件:** [点此跳转](https://gitgud.io/StageDog/tavern_resource/-/tree/main/src)

## 功能

像 [NoAss](https://gitgud.io/Monblant/noass) 那样,

- 压缩相邻同身份消息
- 将聊天消息转换为单个身份消息
- 剥离系统深度条目 (D⚙ 条目)
- 设定停止字符串

从而,

- 内容理解更连贯: 在发送给 llm 后，消息和消息之间可能存在 <|im_start|>system 等间隔，而压缩相邻同身份消息后自然省去了这些间隔
- 自建对话语境: 所有聊天记录合并成一个消息里的 A 和 B 对话而不是 user 和 ai 对话，免受模型有关 user 和 ai 对话理解的影响

## 谁可以用?

### 玩家

本脚本的默认配置适用于大部分预设, 一般能优化 AI 对提示词的理解, 嗯, 至少很难出现副作用.

### 预设作者

对于预设作者, 本脚本能够调整很多原本不能调整的提示词细节, 也许其中有你想要调整的.

脚本的设置直接存储在脚本内, 将脚本放在酒馆助手的预设脚本库后, 可以随预设一同导出.

### 角色卡作者

虽然按照[一些预设作者和角色卡作者的说法](https://discord.com/channels/1134557553011998840/1413538722078785576), Gemini 和 Claude 不同, 不必将条目插入聊天记录中, 插入其中反而会干扰聊天记录的连续性, 重要条目应该都插入到 D0.

但玩家依旧可能使用 Claude、GPT 等游玩, 而对它们还是需要用 D4 等深度的.

为了满足两种不同设置方案, 你可以针对 Claude 谨慎使用 D4、D2 等深度, 然后把本脚本塞到角色卡脚本库里, 让有需要的 Gemini 玩家自行开启.

## 重复脚本检查

当有多个压缩相邻消息脚本被启用时, 只有排在脚本库最下面的一个脚本会生效, 因此保证了预设脚本优先于角色脚本优先于全局脚本, 避免发生设置冲突.

## 明明有 NoAss, 为什么又造轮子?

之所以重新写一个，是因为

- 不想多装个插件
- NoAss 原仓库的实现方式是直接自己组装提示词, 性能不是很好, 且不兼容很多插件、脚本
- 试试用 Vue 写前端界面
