# 处理聊天历史

酒馆的聊天历史 (预设中的 Chat History 条目) 记录了玩家和 AI 的每楼层提示词, 也就是实际游玩的内容.

聊天记录往往是一问一答的: 一条用户输入、一条 AI 输出、一条用户输入……AI 团队可能针对这种对话进行了一些特殊训练, 而我们游玩酒馆恰因为这些训练出现问题 (出现八股、文风变差之类的).

因此本脚本允许你对聊天历史进行额外处理:

- 仅合并相邻同身份提示词: 将聊天历史中相邻且身份相同的提示词合并, 例如世界书条目 A 和 B 都插入到 D1 作为系统提示词, 则会被合并成一条提示词
- **压缩为单条提示词**: 先合并相邻同身份提示词, 再将整个聊天历史压缩为一条提示词

其中, 压缩为单条提示词就是为了避免受 AI 团队对人机对话的训练影响. 它将原本的一问一答附上相应的身份前后缀, 然后合并成一条提示词, 例如:

```text
{{user}}:
我输入了一段话

剧情:
AI 根据输入的话生成了一段文本

{{user}}:
我又输入了一段话
```

不过, 由于聊天记录被压缩成单条提示词发给 AI, AI 可能误认为它就该输出这样的一长串对话.

为了避免它自问自答, 你可以在停止字符串中填入它应该在什么时候中止输出. (对于上面的例子, 我们可以填写 `{{user}}:` 作为停止字符串.)
